<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CR√âDITOS LA BENDICI√ìN - Sistema de Gesti√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f8fafc; 
            color: #2d3748; 
        }
        .container { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 250px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 20px; 
            position: fixed; 
            height: 100vh; 
            overflow-y: auto; 
        }
        .logo { 
            font-size: 24px; 
            font-weight: bold; 
            margin-bottom: 30px; 
            text-align: center; 
            padding: 20px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 12px; 
        }
        .nav-menu { list-style: none; }
        .nav-item { margin-bottom: 10px; }
        .nav-link { 
            display: flex; 
            align-items: center; 
            padding: 15px 20px; 
            color: white; 
            text-decoration: none; 
            border-radius: 10px; 
            transition: all 0.3s ease; 
            cursor: pointer; 
        }
        .nav-link:hover { 
            background: rgba(255,255,255,0.2); 
            transform: translateX(5px); 
        }
        .nav-link.active { 
            background: rgba(255,255,255,0.3); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
        }
        .nav-link span:first-child { margin-right: 10px; font-size: 18px; }
        .main-content { 
            margin-left: 250px; 
            flex: 1; 
            padding: 20px; 
        }
        .page-header { 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .page-title { 
            font-size: 28px; 
            font-weight: 600; 
            color: #2d3748; 
        }
        .user-info { 
            background: #e2e8f0; 
            padding: 10px 20px; 
            border-radius: 8px; 
            color: #4a5568; 
        }
        .page-content { 
            background: white; 
            border-radius: 12px; 
            padding: 30px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            display: none; 
        }
        .page-content.active { display: block; }
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: all 0.3s ease; 
            margin: 5px; 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-primary { background: #4299e1; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn-secondary { background: #718096; color: white; }
        .card { 
            background: white; 
            border-radius: 12px; 
            padding: 25px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .table th { background: #f7fafc; font-weight: 600; color: #2d3748; }
        .table tr:hover { background: #f7fafc; }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            justify-content: center; 
            align-items: center; 
            overflow-y: auto; 
            padding: 20px;
        }
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            width: 95%; 
            max-width: 700px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            margin: auto;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #2d3748; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s ease; 
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            border-color: #4299e1; 
            outline: none; 
        }
        .form-group input[readonly] {
            background-color: #f7fafc;
            color: #4a5568;
            cursor: not-allowed;
        }

        /* Estilos espec√≠ficos para el formulario de cobro */
        #collectionForm {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: 10px;
        }

        #collectionForm::-webkit-scrollbar {
            width: 6px;
        }

        #collectionForm::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #collectionForm::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        #collectionForm::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Estilos para secciones del formulario */
        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .form-section h4 {
            margin: 0 0 15px 0;
            color: #4a5568;
            font-size: 16px;
            font-weight: 600;
        }

        /* Responsive para campos en grid */
        .form-row {
            display: grid;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr !important;
            }
            
            .modal-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
            }
        }
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 15px 25px; 
            border-radius: 8px; 
            color: white; 
            font-weight: 500; 
            z-index: 1001; 
            animation: slideIn 0.3s ease; 
        }
        .notification.success { background: #48bb78; }
        .notification.error { background: #e53e3e; }
        .notification.info { background: #4299e1; }
        @keyframes slideIn { 
            from { transform: translateX(100%); opacity: 0; } 
            to { transform: translateX(0); opacity: 1; } 
        }
        .logout-btn { 
            position: absolute; 
            bottom: 20px; 
            left: 20px; 
            right: 20px; 
            background: #e53e3e; 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
        }
        .logout-btn:hover { background: #c53030; }
        

    </style>
</head>
<body>

    
    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="logo">üí∞ CR√âDITOS LA BENDICI√ìN</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="navigateTo('dashboard')">
                        <span>üìä</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="navigateTo('clients')">
                        <span>üë•</span>
                        <span>Clientes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="navigateTo('collections')">
                        <span>üí∞</span>
                        <span>Cobros</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="navigateTo('reports')">
                        <span>üìà</span>
                        <span>Reportes</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="openBackupModal()">
                        <span>üíæ</span>
                        <span>Backup & Recuperaci√≥n</span>
                    </a>
                </li>
            </ul>
            
            <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <span id="userName">Usuario Demo</span>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page-content active">
                <h2>üìä Panel de Control</h2>
                <p>Bienvenido al Sistema de Gesti√≥n de Cobros y Clientes</p>
                
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 30px;">
                    <h3 style="color: white; margin-bottom: 10px;">üì± Enviar Reportes por WhatsApp</h3>
                    <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">Env√≠a reportes personalizados de deuda y pagos directamente a cada cliente</p>
                    <button class="btn" onclick="openWhatsAppReportModal()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3);">üì± Generar Reporte WhatsApp</button>
                    <br><br>
                    <small style="color: rgba(255,255,255,0.8);">üîç ¬øProblemas con WhatsApp? 
                        <button onclick="diagnoseWhatsApp()" style="background: #4299e1; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 5px;">
                            üîß Diagn√≥stico
                        </button>
                    </small>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div class="card">
                        <h3>üë• Total Clientes</h3>
                        <p style="font-size: 32px; color: #4299e1; font-weight: bold;" id="totalClients">0</p>
                    </div>
                    <div class="card">
                        <h3>üí∞ Cobros del Mes</h3>
                        <p style="font-size: 32px; color: #48bb78; font-weight: bold;" id="totalCollections">$0</p>
                    </div>
                    <div class="card">
                        <h3>üìà Ganancias del Mes</h3>
                        <p style="font-size: 32px; color: #9f7aea; font-weight: bold;" id="monthlyProfits">$0</p>
                        <p style="font-size: 14px; color: #718096; margin-top: 5px;">Ingresos netos actuales</p>
                    </div>
                    <div class="card">
                        <h3>üìÑ Exportar Datos</h3>
                        <p>Genera reportes en PDF</p>
                        <button class="btn btn-primary" onclick="exportToPDF()">Exportar PDF</button>
                    </div>
                    <div class="card">
                        <h3>üìä Reportes</h3>
                        <p>Genera reportes detallados de tu negocio</p>
                        <button class="btn btn-primary" onclick="navigateTo('reports')">Ver Reportes</button>
                    </div>

                    <div class="card">
                        <h3>üíæ Backup de Datos</h3>
                        <p>Respalda y restaura tu informaci√≥n</p>
                        <button class="btn btn-primary" onclick="openBackupModal()">Gestionar Backup</button>
                    </div>
                </div>
            </div>

            <!-- Clients Page -->
            <div id="clients-page" class="page-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>üë• Gesti√≥n de Clientes</h2>
                    <div>
                        <button class="btn btn-primary" onclick="openClientModal()">+ Nuevo Cliente</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Lista de Clientes</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Direcci√≥n</th>
                                    <th>Tel√©fono</th>
                                    <th>Fecha Registro</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <tr>
                                    <td colspan="5" style="text-align: center; color: #718096;">No hay clientes registrados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Collections Page -->
            <div id="collections-page" class="page-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>üí∞ Registro de Pr√©stamos</h2>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-success" onclick="openPaymentModal()">üí≥ Registrar Pago</button>
                        <button class="btn btn-primary" onclick="openCollectionModal()">+ Registrar Pr√©stamo</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Historial de Pr√©stamos</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Base</th>
                                    <th>Porcentaje</th>
                                    <th>Pagos Diarios</th>
                                    <th>Cuotas</th>
                                    <th>Total</th>
                                    <th>Restante</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Descripci√≥n</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="collectionsTableBody">
                                <tr>
                                    <td colspan="11" style="text-align: center; color: #718096;">No hay cobros registrados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Historial de Pagos -->
                <div class="card" style="margin-top: 30px;">
                    <h3>üí≥ Historial de Pagos</h3>
                    
                    <!-- Campo de b√∫squeda -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label for="paymentSearch" style="font-weight: 600; color: #4a5568;">üîç Buscar por nombre:</label>
                            <input type="text" id="paymentSearch" placeholder="Escribir nombre del cliente..." 
                                   style="padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; flex: 1; max-width: 300px;"
                                   oninput="searchPayments()">
                            <button class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;" onclick="clearPaymentSearch()">Limpiar</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Monto Pagado</th>
                                    <th>Fecha</th>
                                    <th>Descripci√≥n</th>
                                    <th>Restante</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #718096;">No hay pagos registrados</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports-page" class="page-content">
                <h2>üìà Reportes y Estad√≠sticas</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="card">
                        <h3>Reporte Mensual</h3>
                        <p>Genera un reporte detallado del mes actual</p>
                        <button class="btn btn-success" onclick="generateMonthlyReport()">Generar Reporte</button>
                    </div>
                    
                    <div class="card">
                        <h3>Resumen de Clientes</h3>
                        <p>Estad√≠sticas completas de todos los clientes</p>
                        <button class="btn btn-warning" onclick="generateClientsReport()">Reporte Clientes</button>
                    </div>
                    
                    <div class="card">
                        <h3>Exportar Datos</h3>
                        <p>Descarga todos los datos en formato CSV</p>
                        <button class="btn btn-primary" onclick="exportData()">Exportar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <h2 id="clientModalTitle">Nuevo Cliente</h2>
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <div class="form-group">
                    <label for="clientName">Nombre Completo *</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label for="clientAddressRequired">Direcci√≥n *</label>
                    <input type="text" id="clientAddressRequired" required>
                </div>
                <div class="form-group">
                    <label for="clientPhone">Tel√©fono *</label>
                    <input type="tel" id="clientPhone" required>
                </div>
                <div class="form-group">
                    <label for="clientAddress">Direcci√≥n</label>
                    <textarea id="clientAddress" rows="3"></textarea>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Collection Modal -->
    <div id="collectionModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px; color: #2d3748;">Registrar Pr√©stamo</h2>
            <form id="collectionForm">
                <!-- Secci√≥n: Informaci√≥n del Cliente -->
                <div class="form-section">
                    <h4 style="color: #4a5568; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">üìã Cliente</h4>
                    <div class="form-group">
                        <label for="collectionClient">Cliente *</label>
                        <select id="collectionClient" required>
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                </div>

                <!-- Secci√≥n: Montos y C√°lculos -->
                <div class="form-section">
                    <h4 style="color: #4a5568; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">üí∞ Montos y C√°lculos</h4>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="collectionAmount">Monto Base *</label>
                            <input type="text" id="collectionAmount" placeholder="0" required oninput="calculateTotals(); formatInput(this); updateAmountUnit()" onfocus="removeFormat(this)" onblur="addFormat(this)">
                            <small id="amountUnitDisplay" style="color: #4299e1; font-weight: 500; display: block; margin-top: 5px;"></small>
                        </div>
                        <div class="form-group">
                            <label for="collectionPercentage">Porcentaje (%) *</label>
                            <input type="number" id="collectionPercentage" min="0" max="100" step="0.1" placeholder="20" required oninput="calculateTotals()">
                            <small id="percentageDisplay" style="color: #4299e1; font-weight: 500; display: block; margin-top: 5px;">Ejemplo: 20 = 20%</small>
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="collectionTotal">Total con %</label>
                            <input type="text" id="collectionTotal" readonly>
                        </div>
                        <div class="form-group">
                            <label for="collectionRemaining">Restante</label>
                            <input type="text" id="collectionRemaining" readonly>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="collectionStatus">Estado del Cr√©dito</label>
                        <select id="collectionStatus">
                            <option value="activo">üü¢ Activo</option>
                            <option value="cumplido">‚úÖ Cumplido</option>
                            <option value="vencido">üî¥ Vencido</option>
                        </select>
                    </div>
                </div>

                <!-- Secci√≥n: Detalles del Pago -->
                <div class="form-section">
                    <h4 style="color: #4a5568; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">üìä Detalles del Pago</h4>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="collectionDailyPayments">Pagos Diarios</label>
                            <input type="number" id="collectionDailyPayments" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="collectionInstallments">Cuotas</label>
                            <input type="number" id="collectionInstallments" min="1" value="1">
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n: Informaci√≥n Adicional -->
                <div class="form-section">
                    <h4 style="color: #4a5568; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">üìÖ Informaci√≥n Adicional</h4>
                    <div class="form-group">
                        <label for="collectionDate">Fecha *</label>
                        <input type="date" id="collectionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="collectionDescription">Descripci√≥n</label>
                        <textarea id="collectionDescription" rows="3" placeholder="Descripci√≥n adicional del cobro..."></textarea>
                    </div>
                </div>

                <!-- Botones -->
                <div class="modal-buttons" style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; position: sticky; bottom: 0; background: white;">
                    <button type="button" class="btn btn-secondary" onclick="closeCollectionModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Registrar Pr√©stamo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 25px; color: #2d3748;">üí≥ Registrar Pago</h2>
            <form id="paymentForm">
                <!-- Secci√≥n: Cliente y Deuda -->
                <div class="form-section">
                    <h4 style="color: #4a5568; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">üë§ Cliente y Deuda</h4>
                    <div class="form-group">
                        <label for="paymentClient">Cliente *</label>
                        <select id="paymentClient" required onchange="updateClientDebt()">
                            <option value="">Seleccionar cliente</option>
                        </select>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="currentDebt">Deuda Actual</label>
                            <input type="number" id="currentDebt" step="0.01" readonly style="background-color: #f7fafc; color: #4a5568;">
                        </div>
                        <div class="form-group">
                            <label for="totalPaid">Total Pagado</label>
                            <input type="number" id="totalPaid" step="0.01" readonly style="background-color: #f7fafc; color: #4a5568;">
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n: Nuevo Pago -->
                <div class="form-section">
                    <h4 style="color: #4a5568; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">üí∞ Nuevo Pago</h4>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="paymentAmount">Monto a Pagar *</label>
                            <input type="text" id="paymentAmount" placeholder="0" required oninput="formatInput(this); calculateRemaining(); updatePaymentAmountUnit()" onfocus="removeFormat(this)" onblur="addFormat(this)">
                            <small id="paymentAmountUnitDisplay" style="color: #4299e1; font-weight: 500; display: block; margin-top: 5px;"></small>
                        </div>
                        <div class="form-group">
                            <label for="remainingAfterPayment">Restante Despu√©s del Pago</label>
                            <input type="number" id="remainingAfterPayment" step="0.01" readonly style="background-color: #f7fafc; color: #4a5568;">
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n: Informaci√≥n del Pago -->
                <div class="form-section">
                    <h4 style="color: #4a5568; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px;">üìÖ Informaci√≥n del Pago</h4>
                    <div class="form-group">
                        <label for="paymentDate">Fecha *</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentDescription">Descripci√≥n</label>
                        <textarea id="paymentDescription" rows="3" placeholder="Descripci√≥n del pago..."></textarea>
                    </div>
                </div>

                <!-- Botones -->
                <div class="modal-buttons" style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; position: sticky; bottom: 0; background: white;">
                    <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success">Registrar Pago</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Backup y Recuperaci√≥n -->
    <div id="backupModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h2 style="margin-bottom: 25px; color: #2d3748;">üíæ Backup y Recuperaci√≥n de Datos</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- Secci√≥n de Backup -->
                <div class="backup-section" style="background: #f0fff4; padding: 20px; border-radius: 10px; border: 2px solid #68d391;">
                    <h3 style="color: #22543d; margin-bottom: 15px;">üì§ Crear Backup</h3>
                    <p style="color: #276749; margin-bottom: 20px; font-size: 14px;">Respalda toda tu informaci√≥n</p>
                    <button class="btn" onclick="createBackup()" style="background: #48bb78; color: white; width: 100%; margin-bottom: 10px;">
                        üíæ Crear Backup Completo
                    </button>
                    <button class="btn btn-secondary" onclick="exportClientsData()" style="width: 100%;">
                        üë• Solo Clientes
                    </button>
                </div>

                <!-- Secci√≥n de Recuperaci√≥n -->
                <div class="restore-section" style="background: #fffbf0; padding: 20px; border-radius: 10px; border: 2px solid #f6ad55;">
                    <h3 style="color: #744210; margin-bottom: 15px;">üì• Restaurar Datos</h3>
                    <p style="color: #975a16; margin-bottom: 20px; font-size: 14px;">Recupera informaci√≥n guardada</p>
                    <button class="btn" onclick="document.getElementById('backupFile').click()" style="background: #ed8936; color: white; width: 100%; margin-bottom: 10px;">
                        üìÅ Restaurar desde Archivo
                    </button>
                    <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="restoreFromFile(event)">
                    <button class="btn btn-secondary" onclick="showBackupHistory()" style="width: 100%;">
                        üìã Historial de Backups
                    </button>
                </div>
            </div>

            <!-- Informaci√≥n del Sistema -->
            <div style="background: #ebf8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="color: #2a4365; margin-bottom: 10px;">‚ÑπÔ∏è Informaci√≥n del Sistema</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 14px;">
                    <div style="text-align: center;">
                        <strong style="color: #2a4365;">üë• Clientes:</strong><br>
                        <span id="backupClientsCount" style="color: #2d3748;">0</span>
                    </div>
                    <div style="text-align: center;">
                        <strong style="color: #2a4365;">üí∞ Pr√©stamos:</strong><br>
                        <span id="backupCollectionsCount" style="color: #2d3748;">0</span>
                    </div>
                    <div style="text-align: center;">
                        <strong style="color: #2a4365;">üí≥ Pagos:</strong><br>
                        <span id="backupPaymentsCount" style="color: #2d3748;">0</span>
                    </div>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button class="btn btn-secondary" onclick="clearAllData()" style="background: #e53e3e; color: white;">
                    üóëÔ∏è Limpiar Todo
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" onclick="closeBackupModal()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>



    <script>
        // ===== SISTEMA DE NAVEGACI√ìN MEJORADO =====
        let currentPage = 'dashboard';
        let clients = JSON.parse(localStorage.getItem('clients_demo_user') || '[]');
        let collections = JSON.parse(localStorage.getItem('collections_demo_user') || '[]');
        let payments = JSON.parse(localStorage.getItem('payments_demo_user') || '[]');





        function navigateTo(pageName) {
            try {
                // Verificar que la p√°gina existe
                const targetPage = document.getElementById(pageName + '-page');
                if (!targetPage) {
                    showNotification(`Error: P√°gina ${pageName} no encontrada`, 'error');
                    return;
                }

                // Ocultar todas las p√°ginas
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.remove('active');
                    page.style.display = 'none';
                });

                // Mostrar p√°gina espec√≠fica
                targetPage.classList.add('active');
                targetPage.style.display = 'block';

                // Actualizar navegaci√≥n
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                const activeLink = document.querySelector(`[onclick="navigateTo('${pageName}')"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }

                // Actualizar t√≠tulo
                const titles = {
                    dashboard: 'Dashboard',
                    clients: 'Gesti√≥n de Clientes',
                    collections: 'Registro de Cobros',
                    reports: 'Reportes y Estad√≠sticas'
                };
                
                document.getElementById('pageTitle').textContent = titles[pageName] || pageName;
                currentPage = pageName;

                // Cargar contenido espec√≠fico
                if (typeof loadPageContent === 'function') {
                    loadPageContent(pageName);
                }
                
            } catch (error) {
                showNotification(`Error de navegaci√≥n: ${error.message}`, 'error');
            }
        }

        // ===== MANEJO DE CLIENTES =====
        function openClientModal() {
            // Navegar autom√°ticamente a clientes
            navigateTo('clients');
            
            setTimeout(() => {
                const modal = document.getElementById('clientModal');
                const title = document.getElementById('clientModalTitle');
                const form = document.getElementById('clientForm');
                const clientId = document.getElementById('clientId');
                const submitButton = form.querySelector('button[type="submit"]');
                
                if (modal && title && form && clientId) {
                    // Configurar modal para nuevo cliente
                    title.textContent = 'Nuevo Cliente';
                    form.reset();
                    clientId.value = '';
                    
                    // Restaurar texto del bot√≥n
                    if (submitButton) {
                        submitButton.textContent = 'Guardar Cliente';
                    }
                    
                    // Mostrar modal
                    modal.style.display = 'flex';
                    
                    // Focus en primer campo
                    setTimeout(() => {
                        document.getElementById('clientName').focus();
                    }, 200);
                }
            }, 300);
        }

        function closeClientModal() {
            console.log('üîÑ Funci√≥n closeClientModal llamada');
            
            const modal = document.getElementById('clientModal');
            const submitButton = document.querySelector('#clientForm button[type="submit"]');
            
            // Restaurar texto del bot√≥n al cerrar
            if (submitButton) {
                submitButton.textContent = 'Guardar Cliente';
                console.log('‚úÖ Bot√≥n submit restaurado');
            } else {
                console.log('‚ùå Bot√≥n submit no encontrado');
            }
            
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ Modal ocultado');
            } else {
                console.log('‚ùå Modal no encontrado');
            }
        }

        function handleClientSubmit(e) {
            e.preventDefault();
            console.log('üìù Funci√≥n handleClientSubmit llamada');
            
            const name = document.getElementById('clientName').value.trim();
            const address = document.getElementById('clientAddressRequired').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            const optionalAddress = document.getElementById('clientAddress').value.trim();
            const clientId = document.getElementById('clientId').value;
            
            console.log('üìã Datos del formulario:', { name, address, phone, optionalAddress, clientId });
            
            // Validaci√≥n
            if (!name || !address || !phone) {
                console.log('‚ùå Validaci√≥n fallida - campos vac√≠os');
                showNotification('Por favor completa todos los campos obligatorios', 'error');
                return;
            }
            
            if (clientId) {
                console.log('‚úèÔ∏è Modo EDICI√ìN - ID del cliente:', clientId);
                // EDITAR CLIENTE EXISTENTE
                const clientIndex = clients.findIndex(c => c.id === clientId);
                if (clientIndex === -1) {
                    console.log('‚ùå Cliente no encontrado en el array');
                    showNotification('Error: Cliente no encontrado', 'error');
                    return;
                }
                
                // Actualizar cliente
                clients[clientIndex] = {
                    ...clients[clientIndex],
                    name: name,
                    email: address, // Usamos el campo obligatorio como email por compatibilidad
                    phone: phone,
                    address: optionalAddress || address, // Usar direcci√≥n obligatoria si no hay opcional
                    dateModified: new Date().toISOString()
                };
                
                // Guardar en localStorage
                localStorage.setItem('clients_demo_user', JSON.stringify(clients));
                
                console.log('‚úÖ Cliente actualizado exitosamente');
                showNotification('Cliente actualizado exitosamente', 'success');
                
            } else {
                console.log('‚ûï Modo CREACI√ìN - Nuevo cliente');
                // CREAR NUEVO CLIENTE
                const client = {
                    id: generateId(),
                    name: name,
                    email: address, // Usamos el campo obligatorio como email por compatibilidad
                    phone: phone,
                    address: optionalAddress || address, // Usar direcci√≥n obligatoria si no hay opcional
                    dateAdded: new Date().toISOString()
                };
                
                // Guardar en localStorage
                clients.push(client);
                localStorage.setItem('clients_demo_user', JSON.stringify(clients));
                
                console.log('‚úÖ Cliente creado exitosamente');
                showNotification('Cliente agregado exitosamente', 'success');
            }
            
            // Cerrar modal y actualizar tabla
            console.log('üîÑ Cerrando modal y actualizando tabla...');
            closeClientModal();
            updateClientsTable();
            updateDashboardStats();
            console.log('‚úÖ Proceso completado');
        }

        function testClientFunction() {
            try {
                openClientModal();
                setTimeout(() => {
                    const modal = document.getElementById('clientModal');
                    const isOpen = modal.style.display === 'flex';
                    
                    if (isOpen) {
                        closeClientModal();
                        showNotification('Test exitoso: Modal se abre correctamente', 'success');
                    } else {
                        showNotification('Test fallido: Modal no se abre', 'error');
                    }
                }, 500);
            } catch (error) {
                showNotification(`Error en test: ${error.message}`, 'error');
            }
        }

        // ===== MANEJO DE COBROS =====
        // ===== FUNCIONES DE WHATSAPP =====
        function openWhatsAppReportModal() {
            console.log('üîç Abriendo modal WhatsApp desde dashboard');
            
            // Verificar si hay clientes registrados
            if (clients.length === 0) {
                showNotification('‚ùå No hay clientes registrados. Primero agrega un cliente para poder enviar WhatsApp.', 'warning');
                return;
            }
            
            // Verificar clientes con datos completos
            const validClients = clients.filter(client => 
                client.name && 
                client.phone && 
                client.name.trim() !== '' && 
                client.phone.trim() !== ''
            );
            
            if (validClients.length === 0) {
                showNotification('‚ùå No hay clientes con datos completos. Verifica que tengan nombre y tel√©fono.', 'warning');
                return;
            }
            
            console.log(`‚úÖ Encontrados ${validClients.length} clientes v√°lidos`);
            
            const modal = document.getElementById('clientModal');
            const title = document.getElementById('clientModalTitle');
            const form = document.getElementById('clientForm');
            
            if (modal && title && form) {
                title.textContent = 'üì± Generar Reporte WhatsApp';
                form.innerHTML = `
                    <div class="form-group">
                        <label for="whatsappClient">Seleccionar Cliente *</label>
                        <select id="whatsappClient" required onchange="updateWhatsAppPreview()">
                            <option value="">Seleccionar cliente</option>
                            ${validClients.map(client => `<option value="${client.id}">${client.name} - ${client.phone}</option>`).join('')}
                        </select>
                        <small style="color: #718096; font-size: 12px;">
                            üìä ${validClients.length} cliente(s) disponible(s)
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="whatsappMessageType">Tipo de Reporte</label>
                        <select id="whatsappMessageType" onchange="updateWhatsAppPreview()">
                            <option value="deuda">üìã Reporte de Deuda</option>
                            <option value="pagos">üí∞ Historial de Pagos</option>
                            <option value="completo">üìä Reporte Completo</option>
                            <option value="recordatorio">üîî Recordatorio de Pago</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mensaje de Ejemplo</label>
                        <div id="whatsappPreview" style="background: #f7fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 12px; color: #4a5568;">
                            Selecciona un cliente y tipo de reporte para ver el mensaje
                        </div>
                    </div>
                `;
                
                // Actualizar bot√≥n de env√≠o
                const buttonsDiv = form.querySelector('div[style*="text-align: right"]');
                console.log('üîç Buscando contenedor de botones...', buttonsDiv);
                
                if (buttonsDiv) {
                    buttonsDiv.innerHTML = `
                        <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancelar</button>
                        <button type="button" class="btn btn-success" onclick="sendWhatsAppFromModal()">üì± Enviar WhatsApp</button>
                    `;
                    console.log('‚úÖ Botones de WhatsApp agregados correctamente');
                } else {
                    console.error('‚ùå No se encontr√≥ el contenedor de botones');
                    // Si no encuentra el contenedor, crearlo manualmente
                    form.innerHTML += `
                        <div style="text-align: right; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancelar</button>
                            <button type="button" class="btn btn-success" onclick="sendWhatsAppFromModal()">üì± Enviar WhatsApp</button>
                        </div>
                    `;
                    console.log('‚úÖ Botones creados manualmente');
                }
                
                // Actualizar preview inicialmente
                setTimeout(() => {
                    updateWhatsAppPreview();
                }, 100);
                
                modal.style.display = 'flex';
                console.log('‚úÖ Modal WhatsApp abierto correctamente');
                
            } else {
                console.error('‚ùå Elementos del modal no encontrados:', { modal: !!modal, title: !!title, form: !!form });
                showNotification('Error: Modal no encontrado. Recarga la p√°gina.', 'error');
            }
        }
        
        function updateWhatsAppPreview() {
            const clientSelect = document.getElementById('whatsappClient');
            const messageTypeSelect = document.getElementById('whatsappMessageType');
            const previewDiv = document.getElementById('whatsappPreview');
            
            if (!clientSelect || !messageTypeSelect || !previewDiv) {
                console.log('‚ö†Ô∏è Elementos de preview no encontrados');
                return;
            }
            
            const selectedClientId = clientSelect.value;
            const messageType = messageTypeSelect.value;
            
            if (!selectedClientId || !messageType) {
                previewDiv.innerHTML = 'Selecciona un cliente y tipo de reporte para ver el mensaje';
                return;
            }
            
            const client = clients.find(c => c.id === selectedClientId);
            if (!client) {
                previewDiv.innerHTML = 'Cliente no encontrado';
                return;
            }
            
            const message = generateClientReport(client, messageType, '');
            previewDiv.innerHTML = `<strong>Para ${client.name}:</strong><br><br>${message.replace(/\n/g, '<br>')}`;
            console.log('‚úÖ Preview actualizado para:', client.name, 'tipo:', messageType);
        }
        
        function diagnoseWhatsApp() {
            console.log('üîç === DIAGN√ìSTICO WHATSAPP ===');
            
            let diagnosis = 'üîç DIAGN√ìSTICO DEL SISTEMA WHATSAPP\n\n';
            
            // 1. Verificar clientes
            diagnosis += `üë• CLIENTES:\n`;
            diagnosis += `‚Ä¢ Total de clientes: ${clients.length}\n`;
            
            const validClients = clients.filter(client => 
                client.name && 
                client.phone && 
                client.name.trim() !== '' && 
                client.phone.trim() !== ''
            );
            diagnosis += `‚Ä¢ Clientes v√°lidos: ${validClients.length}\n`;
            
            if (clients.length === 0) {
                diagnosis += `‚ùå PROBLEMA: No hay clientes registrados\n`;
                diagnosis += `‚úÖ SOLUCI√ìN: Haz clic en "Agregar Clientes de Prueba"\n\n`;
            } else if (validClients.length === 0) {
                diagnosis += `‚ùå PROBLEMA: No hay clientes con datos completos\n`;
                diagnosis += `‚úÖ SOLUCI√ìN: Verifica que los clientes tengan nombre y tel√©fono\n\n`;
            } else {
                diagnosis += `‚úÖ Estado: OK\n\n`;
            }
            
            // 2. Verificar elementos del modal
            diagnosis += `ü™ü MODAL:\n`;
            const modal = document.getElementById('clientModal');
            const title = document.getElementById('clientModalTitle');
            const form = document.getElementById('clientForm');
            
            diagnosis += `‚Ä¢ Modal HTML: ${modal ? '‚úÖ Encontrado' : '‚ùå No encontrado'}\n`;
            diagnosis += `‚Ä¢ Modal Title: ${title ? '‚úÖ Encontrado' : '‚ùå No encontrado'}\n`;
            diagnosis += `‚Ä¢ Modal Form: ${form ? '‚úÖ Encontrado' : '‚ùå No encontrado'}\n\n`;
            
            // 3. Verificar funciones
            diagnosis += `‚öôÔ∏è FUNCIONES:\n`;
            diagnosis += `‚Ä¢ openWhatsAppReportModal: ${typeof openWhatsAppReportModal === 'function' ? '‚úÖ OK' : '‚ùå No encontrada'}\n`;
            diagnosis += `‚Ä¢ generateClientReport: ${typeof generateClientReport === 'function' ? '‚úÖ OK' : '‚ùå No encontrada'}\n`;
            diagnosis += `‚Ä¢ sendWhatsAppToClient: ${typeof sendWhatsAppToClient === 'function' ? '‚úÖ OK' : '‚ùå No encontrada'}\n\n`;
            
            // 4. Resumen y recomendaciones
            diagnosis += `üìã RESUMEN:\n`;
            
            let issues = [];
            if (clients.length === 0) {
                issues.push('Crear clientes de prueba');
            }
            if (!modal || !title || !form) {
                issues.push('Recargar p√°gina');
            }
            if (typeof openWhatsAppReportModal !== 'function') {
                issues.push('Revisar funciones JavaScript');
            }
            
            if (issues.length === 0) {
                diagnosis += `‚úÖ Todo est√° configurado correctamente.\n`;
                diagnosis += `‚úÖ Puedes hacer clic en "Generar Reporte WhatsApp" sin problemas.\n\n`;
                diagnosis += `üí° Si a√∫n no funciona, prueba:\n`;
                diagnosis += `‚Ä¢ Recargar la p√°gina\n`;
                diagnosis += `‚Ä¢ Verificar la consola del navegador (F12)\n`;
            } else {
                diagnosis += `‚ùå Se encontraron ${issues.length} problema(s):\n`;
                issues.forEach((issue, index) => {
                    diagnosis += `${index + 1}. ${issue}\n`;
                });
            }
            
            console.log(diagnosis);
            showNotification(diagnosis, 'info', 15000);
        }

        function sendWhatsAppFromModal() {
            const clientSelect = document.getElementById('whatsappClient');
            const messageTypeSelect = document.getElementById('whatsappMessageType');
            
            if (!clientSelect || !messageTypeSelect) {
                showNotification('Error: No se pudieron obtener los datos', 'error');
                return;
            }
            
            const selectedClientId = clientSelect.value;
            const messageType = messageTypeSelect.value;
            
            if (!selectedClientId || !messageType) {
                showNotification('Por favor selecciona un cliente y tipo de reporte', 'error');
                return;
            }
            
            const client = clients.find(c => c.id === selectedClientId);
            if (!client) {
                showNotification('Cliente no encontrado', 'error');
                return;
            }
            
            // Generar mensaje y enviar
            const message = generateClientReport(client, messageType, '');
            const phone = client.phone.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            
            // Abrir WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Cerrar modal
            closeClientModal();
            showNotification(`üì± Mensaje enviado a ${client.name}`, 'success');
        }

        function generateWhatsAppReport() {
            const clientId = document.getElementById('whatsappClient').value;
            const messageType = document.getElementById('whatsappMessageType').value;
            const customMessage = document.getElementById('whatsappCustomMessage') ? 
                document.getElementById('whatsappCustomMessage').value.trim() : '';
            
            if (!clientId) {
                showNotification('Por favor selecciona un cliente', 'error');
                return;
            }
            
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                showNotification('Cliente no encontrado', 'error');
                return;
            }
            
            // Generar el reporte seg√∫n el tipo
            let reportMessage = generateClientReport(client, messageType, customMessage);
            
            // Crear enlace de WhatsApp
            const phone = client.phone.replace(/\D/g, ''); // Remover caracteres no num√©ricos
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(reportMessage)}`;
            
            // Abrir WhatsApp
            window.open(whatsappUrl, '_blank');
            
            closeClientModal();
            showNotification(`Reporte de WhatsApp generado para ${client.name}`, 'success');
        }
        
        function generateClientReport(client, messageType, customMessage) {
            const clientCollections = collections.filter(c => c.clientId === client.id);
            const clientPayments = payments.filter(p => p.clientId === client.id);
            
            let totalDebt = 0;
            let totalPaid = 0;
            let message = '';
            
            // Calcular totales
            clientCollections.forEach(collection => {
                totalDebt += (collection.total || collection.baseAmount || 0);
            });
            
            clientPayments.forEach(payment => {
                totalPaid += payment.amount;
            });
            
            const remaining = totalDebt - totalPaid;
            
            switch (messageType) {
                case 'deuda':
                    message = `üè¶ *REPORTE DE DEUDA - CR√âDITOS LA BENDICI√ìN*

` +
                             `üë§ *Cliente:* ${client.name}
` +
                             `üìû *Tel√©fono:* ${client.phone}
` +
                             `üìç *Direcci√≥n:* ${client.address || client.email}

` +
                             `üí∞ *RESUMEN FINANCIERO*
` +
                             `‚Ä¢ Total adeudado: ${formatCurrency(totalDebt)}
` +
                             `‚Ä¢ Total pagado: ${formatCurrency(totalPaid)}
` +
                             `‚Ä¢ Saldo pendiente: ${formatCurrency(remaining)}

` +
                             `üìÖ *Generado el:* ${new Date().toLocaleDateString('es-ES')}

` +
                             `Gracias por confiar en CR√âDITOS LA BENDICI√ìN`;
                    break;
                    
                case 'pagos':
                    let paymentsList = '';
                    if (clientPayments.length === 0) {
                        paymentsList = '‚Ä¢ No hay pagos registrados';
                    } else {
                        clientPayments.forEach((payment, index) => {
                            paymentsList += `‚Ä¢ ${formatCurrency(payment.amount)} - ${new Date(payment.date).toLocaleDateString('es-ES')}${payment.description ? ` (${payment.description})` : ''}\n`;
                        });
                    }
                    
                    message = `üí≥ *HISTORIAL DE PAGOS - CR√âDITOS LA BENDICI√ìN*

` +
                             `üë§ *Cliente:* ${client.name}

` +
                             `üí∞ *PAGOS REALIZADOS:*
${paymentsList}

` +
                             `üìä *Total pagado:* ${formatCurrency(totalPaid)}
` +
                             `üí∏ *Saldo restante:* ${formatCurrency(remaining)}

` +
                             `üìÖ *Actualizado al:* ${new Date().toLocaleDateString('es-ES')}

` +
                             `¬°Gracias por tus pagos puntuales!`;
                    break;
                    
                case 'completo':
                    let collectionsList = '';
                    let paymentsListComplete = '';
                    
                    if (clientCollections.length === 0) {
                        collectionsList = '‚Ä¢ No hay cr√©ditos registrados';
                    } else {
                        clientCollections.forEach((collection, index) => {
                            const statusIcon = {
                                'activo': 'üü¢',
                                'cumplido': '‚úÖ',
                                'vencido': 'üî¥'
                            }[collection.status || 'activo'];
                            const percentage = collection.percentage || 0;
                            collectionsList += `‚Ä¢ ${formatCurrencyWithUnit(collection.baseAmount)} + ${percentage}% = ${formatCurrency(collection.total)} ${statusIcon}\n` +
                                               `  üìÖ ${new Date(collection.date).toLocaleDateString('es-ES')}${collection.description ? ` - ${collection.description}` : ''}\n`;
                        });
                    }
                    
                    if (clientPayments.length === 0) {
                        paymentsListComplete = '‚Ä¢ No hay pagos registrados';
                    } else {
                        clientPayments.forEach((payment, index) => {
                            paymentsListComplete += `‚Ä¢ ${formatCurrency(payment.amount)} - ${new Date(payment.date).toLocaleDateString('es-ES')}${payment.description ? ` (${payment.description})` : ''}\n`;
                        });
                    }
                    
                    message = `üìä *REPORTE COMPLETO - CR√âDITOS LA BENDICI√ìN*

` +
                             `üë§ *CLIENTE:*
` +
                             `Nombre: ${client.name}
` +
                             `üìû Tel√©fono: ${client.phone}
` +
                             `üìç Direcci√≥n: ${client.address || client.email}${client.address ? '' : `\nüìß Nota: Campo obligatorio usado como direcci√≥n`}

` +
                             `üí∞ *CR√âDITOS ACTIVOS:*
${collectionsList}

` +
                             `üí≥ *HISTORIAL DE PAGOS:*
${paymentsListComplete}

` +
                             `üìà *RESUMEN TOTAL:*
` +
                             `‚Ä¢ Total cr√©ditos: ${formatCurrency(totalDebt)}
` +
                             `‚Ä¢ Total pagado: ${formatCurrency(totalPaid)}
` +
                             `‚Ä¢ Saldo pendiente: ${formatCurrency(remaining)}

` +
                             `üìÖ *Generado:* ${new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}

` +
                             `Gracias por confiar en CR√âDITOS LA BENDICI√ìN üí∞`;
                    break;
                    
                case 'recordatorio':
                    message = `‚è∞ *RECORDATORIO DE PAGO - CR√âDITOS LA BENDICI√ìN*

` +
                             `Hola ${client.name},

` +
                             `Te recordamos que tienes un saldo pendiente de *${formatCurrency(remaining)}*.

` +
                             `üí° *¬øNecesitas ayuda con tu pago?*
` +
                             `üìû Cont√°ctanos: ${client.phone}
` +
                             `üìß Escr√≠benos por este chat

` +
                             `¬°Gracias por tu atenci√≥n!
` +
                             `CR√âDITOS LA BENDICI√ìN`;
                    break;
            }
            
            // Agregar mensaje personalizado si existe
            if (customMessage) {
                message += `\n\nüìù *MENSAJE ADICIONAL:*\n${customMessage}`;
            }
            
            return message;
        }
        
        function sendWhatsAppToClient() {
            // Verificar si hay clientes registrados
            if (clients.length === 0) {
                showNotification('‚ùå No hay clientes registrados. Primero agrega un cliente para poder enviar WhatsApp.', 'warning');
                return;
            }
            
            // Verificar clientes con datos completos
            const validClients = clients.filter(client => 
                client.name && 
                client.phone && 
                client.name.trim() !== '' && 
                client.phone.trim() !== ''
            );
            
            if (validClients.length === 0) {
                showNotification('‚ùå No hay clientes con datos completos. Verifica que tengan nombre y tel√©fono.', 'warning');
                return;
            }
            
            // Abrir modal de selecci√≥n r√°pida
            const modal = document.getElementById('clientModal');
            const title = document.getElementById('clientModalTitle');
            const form = document.getElementById('clientForm');
            
            if (modal && title && form) {
                title.textContent = 'üì± Enviar WhatsApp R√°pido';
                form.innerHTML = `
                    <div class="form-group">
                        <label for="quickWhatsappClient">Seleccionar Cliente *</label>
                        <select id="quickWhatsappClient" required>
                            <option value="">Seleccionar cliente</option>
                            ${validClients.map(client => `<option value="${client.id}">${client.name} (${client.phone})</option>`).join('')}
                        </select>
                        <small style="color: #718096; font-size: 12px;">
                            üìä ${validClients.length} cliente(s) disponible(s)
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="quickMessageType">Tipo de Mensaje</label>
                        <select id="quickMessageType">
                            <option value="deuda">Reporte de Deuda</option>
                            <option value="recordatorio">Recordatorio de Pago</option>
                            <option value="saludo">Saludo/Amistoso</option>
                        </select>
                    </div>
                `;
                
                // Actualizar botones
                const buttonsDiv = form.parentElement.querySelector('div[style*="text-align: right"]');
                buttonsDiv.innerHTML = `
                    <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="sendQuickWhatsApp()">üì± Enviar Ahora</button>
                `;
                
                modal.style.display = 'flex';
            }
        }
        
        function sendQuickWhatsApp() {
            const clientId = document.getElementById('quickWhatsappClient').value;
            const messageType = document.getElementById('quickMessageType').value;
            
            if (!clientId) {
                showNotification('Por favor selecciona un cliente', 'error');
                return;
            }
            
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                showNotification('Cliente no encontrado', 'error');
                return;
            }
            
            let message = '';
            
            switch (messageType) {
                case 'deuda':
                    message = `Hola ${client.name}, te env√≠o tu reporte de deuda actualizado. ¬øTienes alguna consulta?`;
                    break;
                case 'recordatorio':
                    message = `Hola ${client.name}, te recordamos que tienes un pago pendiente. ¬øPodemos ayudarte?`;
                    break;
                case 'saludo':
                    message = `Hola ${client.name}, ¬øc√≥mo est√°s? ¬øTodo bien con tu cr√©dito?`;
                    break;
            }
            
            const phone = client.phone.replace(/\D/g, '');
            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
            closeClientModal();
            showNotification(`WhatsApp enviado a ${client.name}`, 'success');
        }



        function openCollectionModal() {
            navigateTo('collections');
            
            setTimeout(() => {
                const modal = document.getElementById('collectionModal');
                const form = document.getElementById('collectionForm');
                
                if (modal && form) {
                    form.reset();
                    
                    // Llenar selector de clientes
                    const clientSelect = document.getElementById('collectionClient');
                    clientSelect.innerHTML = '<option value="">Seleccionar cliente</option>';
                    
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        clientSelect.appendChild(option);
                    });
                    
                    // Establecer fecha actual y porcentaje por defecto
                    document.getElementById('collectionDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('collectionPercentage').value = '20'; // 20% por defecto
                    
                    // Calcular totales iniciales
                    calculateTotals();
                    
                    modal.style.display = 'flex';
                }
            }, 300);
        }

        function closeCollectionModal() {
            const modal = document.getElementById('collectionModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Funci√≥n para mostrar la unidad del monto de pago en tiempo real
        function updatePaymentAmountUnit() {
            const amountInput = document.getElementById('paymentAmount');
            const unitDisplay = document.getElementById('paymentAmountUnitDisplay');
            
            if (amountInput && unitDisplay) {
                const amount = parseFloat(amountInput.value) || 0;
                unitDisplay.textContent = `Unidad: ${getAmountUnit(amount).replace(/\(|\)/g, '')}`;
                
                // Colorear seg√∫n el tipo de unidad
                if (amount >= 1000) {
                    unitDisplay.style.color = '#48bb78'; // Verde para pesos
                } else if (amount >= 100) {
                    unitDisplay.style.color = '#4299e1'; // Azul para centenas
                } else if (amount >= 10) {
                    unitDisplay.style.color = '#ed8936'; // Naranja para decenas
                } else {
                    unitDisplay.style.color = '#718096'; // Gris para unidades
                }
            }
        }

        // Funci√≥n para calcular totales autom√°ticamente
        function calculateTotals() {
            console.log('üßÆ Calculando totales...');
            
            const amountInput = document.getElementById('collectionAmount');
            const percentageInput = document.getElementById('collectionPercentage');
            const totalInput = document.getElementById('collectionTotal');
            
            if (!amountInput || !percentageInput || !totalInput) {
                console.log('‚ùå Elementos de c√°lculo no encontrados');
                return;
            }
            
            // Obtener valor sin formato (remover puntos y comas)
            const baseAmountValue = amountInput.value.replace(/\./g, '').replace(/,/g, '').replace(/[^\d]/g, '');
            const baseAmount = Math.round(parseFloat(baseAmountValue) || 0);
            
            console.log('üí∞ Monto base procesado:', baseAmount);
            
            // Calcular porcentaje espec√≠fico del pr√©stamo
            const percentage = parseFloat(percentageInput.value) || 0;
            const additionalAmount = (baseAmount * percentage) / 100;
            const totalWithPercentage = baseAmount + additionalAmount;
            
            console.log('üìä C√°lculos:');
            console.log(`  - ${percentage}% adicional:`, additionalAmount);
            console.log(`  - Total con ${percentage}%:`, totalWithPercentage);
            
            // Actualizar campos con formato
            totalInput.value = formatNumber(totalWithPercentage);
            
            // Actualizar etiqueta del porcentaje
            const percentageDisplay = document.getElementById('percentageDisplay');
            if (percentageDisplay) {
                percentageDisplay.textContent = `${percentage}% del monto base`;
            }
            
            // Actualizar unidad
            updateAmountUnit();
            
            console.log('‚úÖ Totales actualizados correctamente');
        }

        // ===== MANEJO DE PAGOS =====
        function openPaymentModal() {
            console.log('üöÄ Abriendo modal de pago...');
            
            navigateTo('collections');
            
            setTimeout(() => {
                const modal = document.getElementById('paymentModal');
                const form = document.getElementById('paymentForm');
                
                if (modal && form) {
                    form.reset();
                    
                    // Llenar selector de clientes
                    const clientSelect = document.getElementById('paymentClient');
                    clientSelect.innerHTML = '<option value="">Seleccionar cliente</option>';
                    
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        clientSelect.appendChild(option);
                    });
                    
                    // Establecer fecha actual
                    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                    
                    modal.style.display = 'flex';
                    console.log('‚úÖ Modal de pago abierto');
                    showNotification('Formulario de pago abierto', 'success');
                }
            }, 300);
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateClientDebt() {
            const clientId = document.getElementById('paymentClient').value;
            if (!clientId) {
                document.getElementById('currentDebt').value = '0.00';
                document.getElementById('totalPaid').value = '0.00';
                return;
            }
            
            const clientCollections = collections.filter(c => c.clientId === clientId);
            const clientPayments = payments.filter(p => p.clientId === clientId);
            
            const totalDebt = clientCollections.reduce((sum, collection) => {
                return sum + (collection.total || collection.baseAmount || 0);
            }, 0);
            
            const totalPaid = clientPayments.reduce((sum, payment) => {
                return sum + payment.amount;
            }, 0);
            
            const remaining = totalDebt - totalPaid;
            
            // Almacenar valores sin formato para c√°lculos, pero mostrar formateados
            document.getElementById('currentDebt').value = remaining;
            document.getElementById('totalPaid').value = totalPaid;
            
            // Actualizar visualizaci√≥n con formato despu√©s de un breve delay
            setTimeout(() => {
                document.getElementById('currentDebt').value = formatNumber(remaining);
                document.getElementById('totalPaid').value = formatNumber(totalPaid);
            }, 10);
            
            // Actualizar el monto m√°ximo que se puede pagar
            const paymentAmount = document.getElementById('paymentAmount');
            paymentAmount.max = remaining;
        }

        function calculateRemaining() {
            const currentDebtValue = document.getElementById('currentDebt').value.replace(/\./g, '');
            const paymentAmountValue = document.getElementById('paymentAmount').value.replace(/\./g, '');
            
            const currentDebt = Math.round(parseFloat(currentDebtValue) || 0);
            const paymentAmount = Math.round(parseFloat(paymentAmountValue) || 0);
            
            if (paymentAmount > currentDebt) {
                document.getElementById('paymentAmount').value = formatNumber(currentDebt);
                document.getElementById('remainingAfterPayment').value = '0';
                showNotification('El monto no puede ser mayor que la deuda actual', 'warning');
            } else {
                const remaining = currentDebt - paymentAmount;
                document.getElementById('remainingAfterPayment').value = formatNumber(remaining);
            }
            
            // Actualizar la unidad mostrada para el pago
            updatePaymentAmountUnit();
        }

        function handlePaymentSubmit(e) {
            e.preventDefault();
            console.log('=== GUARDANDO PAGO ===');
            
            const clientId = document.getElementById('paymentClient').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value.replace(/\./g, '')) || 0;
            const date = document.getElementById('paymentDate').value;
            const description = document.getElementById('paymentDescription').value.trim();
            
            // Validaci√≥n
            if (!clientId) {
                showNotification('Por favor selecciona un cliente', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('Por favor ingresa un monto v√°lido', 'error');
                return;
            }
            
            if (!date) {
                showNotification('Por favor selecciona una fecha', 'error');
                return;
            }
            
            // Verificar que el monto no sea mayor que la deuda
            const currentDebt = parseFloat(document.getElementById('currentDebt').value.replace(/\./g, '')) || 0;
            if (amount > currentDebt) {
                showNotification('El monto no puede ser mayor que la deuda actual', 'error');
                return;
            }
            
            // Crear pago
            const payment = {
                id: generateId(),
                clientId: clientId,
                amount: amount,
                date: date,
                description: description,
                dateCreated: new Date().toISOString()
            };
            
            // Guardar en localStorage
            payments.push(payment);
            localStorage.setItem('payments_demo_user', JSON.stringify(payments));
            
            // Actualizar UI
            closePaymentModal();
            updatePaymentsTable();
            updateDashboardStats();
            
            showNotification('Pago registrado exitosamente', 'success');
        }

        function updatePaymentsTable() {
            const tbody = document.getElementById('paymentsTableBody');
            const searchTerm = document.getElementById('paymentSearch')?.value?.toLowerCase() || '';
            
            // Filtrar pagos por nombre del cliente si hay t√©rmino de b√∫squeda
            let filteredPayments = payments;
            if (searchTerm.trim() !== '') {
                filteredPayments = payments.filter(payment => {
                    const client = clients.find(c => c.id === payment.clientId);
                    const clientName = client ? client.name.toLowerCase() : '';
                    return clientName.includes(searchTerm);
                });
            }
            
            if (filteredPayments.length === 0) {
                const searchMessage = searchTerm.trim() !== '' 
                    ? `No se encontraron pagos para "${searchTerm}"`
                    : 'No hay pagos registrados';
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #718096;">${searchMessage}</td></tr>`;
                return;
            }
            
            tbody.innerHTML = filteredPayments.map(payment => {
                const client = clients.find(c => c.id === payment.clientId);
                const debtStatus = getClientDebtStatus(payment.clientId);
                return `
                    <tr>
                        <td>${client ? client.name : 'Cliente no encontrado'}</td>
                        <td>${formatCurrency(payment.amount)}</td>
                        <td>${new Date(payment.date).toLocaleDateString()}</td>
                        <td>${payment.description || 'Sin descripci√≥n'}</td>
                        <td>
                            <span style="color: ${debtStatus.remaining > 0 ? '#e53e3e' : '#38a169'}">
                                ${formatCurrency(debtStatus.remaining)}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-danger" style="font-size: 12px; padding: 5px 10px;" onclick="deletePayment('${payment.id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getClientDebtStatus(clientId) {
            const clientCollections = collections.filter(c => c.clientId === clientId);
            const clientPayments = payments.filter(p => p.clientId === clientId);
            
            const totalDebt = clientCollections.reduce((sum, collection) => {
                return sum + (collection.total || collection.baseAmount || 0);
            }, 0);
            
            const totalPaid = clientPayments.reduce((sum, payment) => {
                return sum + payment.amount;
            }, 0);
            
            return {
                debt: totalDebt,
                paid: totalPaid,
                remaining: totalDebt - totalPaid
            };
        }

        // ===== FUNCIONES DE B√öSQUEDA EN HISTORIAL DE PAGOS =====
        function searchPayments() {
            updatePaymentsTable();
        }

        function clearPaymentSearch() {
            const searchInput = document.getElementById('paymentSearch');
            if (searchInput) {
                searchInput.value = '';
                updatePaymentsTable();
            }
        }

        function deletePayment(paymentId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este pago?')) {
                return;
            }
            
            payments = payments.filter(p => p.id !== paymentId);
            localStorage.setItem('payments_demo_user', JSON.stringify(payments));
            
            updatePaymentsTable();
            updateDashboardStats();
            
            showNotification('Pago eliminado exitosamente', 'success');
        }

        function handleCollectionSubmit(e) {
            e.preventDefault();
            console.log('=== GUARDANDO PR√âSTAMO ===');
            
            const clientId = document.getElementById('collectionClient').value;
            const amount = parseFloat(document.getElementById('collectionAmount').value.replace(/\./g, '')) || 0;
            const percentage = parseFloat(document.getElementById('collectionPercentage').value) || 0;
            const dailyPayments = parseFloat(document.getElementById('collectionDailyPayments').value.replace(/\./g, '')) || 0;
            const installments = parseInt(document.getElementById('collectionInstallments').value) || 1;
            const total = parseFloat(document.getElementById('collectionTotal').value.replace(/\./g, '')) || 0;
            const remaining = parseFloat(document.getElementById('collectionRemaining').value.replace(/\./g, '')) || 0;
            const date = document.getElementById('collectionDate').value;
            const description = document.getElementById('collectionDescription').value.trim();
            
            // Validaci√≥n
            if (!clientId) {
                showNotification('Por favor selecciona un cliente', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('Por favor ingresa un monto v√°lido', 'error');
                return;
            }
            
            if (!date) {
                showNotification('Por favor selecciona una fecha', 'error');
                return;
            }
            
            const status = document.getElementById('collectionStatus').value || 'activo';
            
            // Crear pr√©stamo con todos los campos
            const collection = {
                id: generateId(),
                clientId: clientId,
                baseAmount: amount,
                percentage: percentage,
                dailyPayments: dailyPayments,
                installments: installments,
                total: total,
                remaining: remaining,
                date: date,
                description: description,
                status: status,
                dateCreated: new Date().toISOString()
            };
            
            // Guardar en localStorage
            collections.push(collection);
            localStorage.setItem('collections_demo_user', JSON.stringify(collections));
            
            console.log('‚úÖ Pr√©stamo guardado:', collection);
            showNotification('Pr√©stamo registrado exitosamente', 'success');
            
            // Cerrar modal y actualizar tabla
            closeCollectionModal();
            updateCollectionsTable();
            updatePaymentsTable();
            updateDashboardStats();
        }

        // ===== FUNCIONES UTILITARIAS =====
        // ===== FUNCIONES DE EXPORTACI√ìN =====
        function exportToPDF() {
            showNotification('Generando reporte PDF...', 'info');
            
            try {
                // Crear contenido HTML para el PDF
                const reportContent = generatePDFContent();
                
                // Crear ventana de impresi√≥n
                const printWindow = window.open('', '_blank');
                printWindow.document.write(reportContent);
                printWindow.document.close();
                
                // Mostrar el di√°logo de impresi√≥n despu√©s de que cargue el contenido
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 500);
                };
                
                showNotification('Reporte PDF generado. Use Ctrl+S para guardar', 'success');
                
            } catch (error) {
                console.error('Error generando PDF:', error);
                showNotification('Error al generar el reporte PDF', 'error');
            }
        }
        
        function generatePDFContent() {
            const now = new Date();
            const totalClients = clients.length;
            const totalCollections = collections.length;
            const totalAmount = collections.reduce((sum, c) => sum + (c.baseAmount || 0), 0);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const monthlyProfits = calculateMonthlyProfits();
            
            let content = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Reporte CR√âDITOS LA BENDICI√ìN</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 20px; 
                        font-size: 12px;
                    }
                    .header { 
                        text-align: center; 
                        border-bottom: 2px solid #333; 
                        padding-bottom: 10px; 
                        margin-bottom: 20px;
                    }
                    .company-name { 
                        font-size: 24px; 
                        font-weight: bold; 
                        color: #667eea;
                        margin-bottom: 5px;
                    }
                    .report-title { 
                        font-size: 18px; 
                        margin-bottom: 10px;
                    }
                    .date { 
                        color: #666;
                    }
                    .summary { 
                        background: #f5f5f5; 
                        padding: 15px; 
                        margin: 20px 0; 
                        border-radius: 5px;
                    }
                    .summary-grid { 
                        display: grid; 
                        grid-template-columns: 1fr 1fr; 
                        gap: 15px;
                    }
                    .summary-item { 
                        text-align: center;
                    }
                    .summary-value { 
                        font-size: 20px; 
                        font-weight: bold; 
                        color: #333;
                    }
                    .summary-label { 
                        color: #666; 
                        margin-top: 5px;
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin: 20px 0;
                    }
                    th, td { 
                        border: 1px solid #ddd; 
                        padding: 8px; 
                        text-align: left;
                    }
                    th { 
                        background-color: #f2f2f2; 
                        font-weight: bold;
                    }
                    .footer { 
                        margin-top: 30px; 
                        text-align: center; 
                        color: #666; 
                        font-size: 10px;
                    }
                    @media print {
                        body { margin: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="company-name">üí∞ CR√âDITOS LA BENDICI√ìN</div>
                    <div class="report-title">REPORTE GENERAL DEL SISTEMA</div>
                    <div class="date">Generado el: ${now.toLocaleDateString('es-ES', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</div>
                </div>
                
                <div class="summary">
                    <h3>üìä RESUMEN EJECUTIVO</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-value">${totalClients}</div>
                            <div class="summary-label">Total Clientes</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${totalCollections}</div>
                            <div class="summary-label">Total Cr√©ditos</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${formatCurrency(totalAmount)}</div>
                            <div class="summary-label">Monto Total Cr√©ditos</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${formatCurrency(totalPaid)}</div>
                            <div class="summary-label">Total Pagado</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${formatCurrency(monthlyProfits)}</div>
                            <div class="summary-label">Ganancias del Mes</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${formatCurrency(totalAmount - totalPaid)}</div>
                            <div class="summary-label">Deuda Pendiente</div>
                        </div>
                    </div>
                </div>
                
                <h3>üë• CLIENTES REGISTRADOS</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nombre</th>
                            <th>Direcci√≥n</th>
                            <th>Tel√©fono</th>
                            <th>Fecha Registro</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            // Agregar clientes
            clients.forEach((client, index) => {
                content += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${client.name}</td>
                            <td>${client.address || client.email}</td>
                            <td>${client.phone}</td>
                            <td>${new Date(client.dateAdded).toLocaleDateString('es-ES')}</td>
                        </tr>`;
            });
            
            content += `
                    </tbody>
                </table>
                
                <h3>üí∞ HISTORIAL DE CR√âDITOS</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Cliente</th>
                            <th>Monto Base</th>
                            <th>% Adicional</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            // Agregar cr√©ditos
            collections.forEach((collection, index) => {
                const client = clients.find(c => c.id === collection.clientId);
                const statusIcon = {
                    'activo': 'üü¢',
                    'cumplido': '‚úÖ',
                    'vencido': 'üî¥'
                }[collection.status || 'activo'];
                
                content += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${client ? client.name : 'N/A'}</td>
                            <td>${formatCurrencyWithUnit(collection.baseAmount || 0)}</td>
                            <td>${formatCurrency(Math.round((collection.baseAmount * collection.percentage / 100) || 0))} (${collection.percentage || 0}%)</td>
                            <td>${formatCurrency(collection.total || 0)}</td>
                            <td>${statusIcon} ${collection.status || 'activo'}</td>
                            <td>${new Date(collection.date).toLocaleDateString('es-ES')}</td>
                        </tr>`;
            });
            
            content += `
                    </tbody>
                </table>
                
                <h3>üìà HISTORIAL DE PAGOS</h3>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Cliente</th>
                            <th>Monto Pagado</th>
                            <th>Fecha</th>
                            <th>Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            // Agregar pagos
            payments.forEach((payment, index) => {
                const client = clients.find(c => c.id === payment.clientId);
                content += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${client ? client.name : 'N/A'}</td>
                            <td>${formatCurrencyWithUnit(payment.amount)}</td>
                            <td>${new Date(payment.date).toLocaleDateString('es-ES')}</td>
                            <td>${payment.description || 'Sin descripci√≥n'}</td>
                        </tr>`;
            });
            
            content += `
                    </tbody>
                </table>
                
                <div class="footer">
                    <p>¬© 2025 CR√âDITOS LA BENDICI√ìN - Sistema de Gesti√≥n Financiera</p>
                    <p>Este reporte fue generado autom√°ticamente por el sistema</p>
                </div>
            </body>
            </html>`;
            
            return content;
        }
        
        // ===== GESTI√ìN DE CR√âDITOS A 30 D√çAS =====
        function checkCreditsAfter30Days() {
            const now = new Date();
            let updatedCount = 0;
            
            collections.forEach(collection => {
                const collectionDate = new Date(collection.date);
                const daysDiff = Math.floor((now - collectionDate) / (1000 * 60 * 60 * 24));
                
                // Si han pasado exactamente 30 d√≠as o m√°s, actualizar estado
                if (daysDiff >= 30 && collection.status !== 'cumplido') {
                    collection.status = 'cumplido';
                    updatedCount++;
                }
            });
            
            // Guardar cambios en localStorage
            if (updatedCount > 0) {
                localStorage.setItem('collections_demo_user', JSON.stringify(collections));
                updateCollectionsTable();
                showNotification(`${updatedCount} cr√©dito(s) actualizado(s) a CUMPLIDO autom√°ticamente`, 'success');
            }
        }
        
        function updateCreditStatus(collectionId, newStatus) {
            const collection = collections.find(c => c.id === collectionId);
            if (collection) {
                collection.status = newStatus;
                localStorage.setItem('collections_demo_user', JSON.stringify(collections));
                updateCollectionsTable();
                updateDashboardStats();
                showNotification(`Estado del cr√©dito actualizado a: ${newStatus}`, 'success');
            }
        }
        
        function formatNumber(num) {
            // Asegurar que num sea un n√∫mero y redondearlo
            const number = Math.round(parseFloat(num) || 0);
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }
        
        // Funci√≥n para formatear entrada de usuario en tiempo real
        function formatInput(input) {
            // Remover formato previo y obtener solo n√∫meros
            const value = input.value.replace(/\./g, '').replace(/[^\d]/g, '');
            const number = parseInt(value) || 0;
            
            // Aplicar formato con puntos de miles
            input.value = formatNumber(number);
        }
        
        // Funci√≥n para remover formato al enfocar el campo
        function removeFormat(input) {
            const value = input.value.replace(/\./g, '');
            input.value = value;
            input.select();
        }
        
        // Funci√≥n para agregar formato al salir del campo
        function addFormat(input) {
            const number = parseInt(input.value.replace(/\./g, '')) || 0;
            input.value = formatNumber(number);
        }
        
        function formatCurrency(amount) {
            return '$' + formatNumber(Math.round(amount));
        }
        
        // Funci√≥n para clasificar montos por unidades
        function getAmountUnit(amount) {
            const num = Math.round(parseFloat(amount) || 0);
            
            if (num >= 1000) {
                return `(${formatNumber(num)} - Pesos)`;
            } else if (num >= 100) {
                return `(${formatNumber(num)} - Centenas)`;
            } else if (num >= 10) {
                return `(${formatNumber(num)} - Decenas)`;
            } else {
                return `(${formatNumber(num)} - Unidades)`;
            }
        }

        // Funci√≥n para formatear moneda con unidad
        function formatCurrencyWithUnit(amount) {
            return `${formatCurrency(amount)} <span class="unit-${getUnitClass(amount)}">(${formatNumber(Math.round(amount))} - ${getUnitText(amount)})</span>`;
        }

        // Funci√≥n auxiliar para obtener la clase CSS de la unidad
        function getUnitClass(amount) {
            const num = Math.round(parseFloat(amount) || 0);
            if (num >= 1000) return 'pesos';
            if (num >= 100) return 'centenas';
            if (num >= 10) return 'decenas';
            return 'unidades';
        }

        // Funci√≥n auxiliar para obtener el texto de la unidad
        function getUnitText(amount) {
            const num = Math.round(parseFloat(amount) || 0);
            if (num >= 1000) return 'Pesos';
            if (num >= 100) return 'Centenas';
            if (num >= 10) return 'Decenas';
            return 'Unidades';
        }

        // Funci√≥n para mostrar la unidad del monto en tiempo real
        function updateAmountUnit() {
            const amountInput = document.getElementById('collectionAmount');
            const unitDisplay = document.getElementById('amountUnitDisplay');
            
            if (amountInput && unitDisplay) {
                const amount = parseFloat(amountInput.value) || 0;
                unitDisplay.textContent = `Unidad: ${getAmountUnit(amount).replace(/\(|\)/g, '')}`;
                
                // Colorear seg√∫n el tipo de unidad
                if (amount >= 1000) {
                    unitDisplay.style.color = '#48bb78'; // Verde para pesos
                } else if (amount >= 100) {
                    unitDisplay.style.color = '#4299e1'; // Azul para centenas
                } else if (amount >= 10) {
                    unitDisplay.style.color = '#ed8936'; // Naranja para decenas
                } else {
                    unitDisplay.style.color = '#718096'; // Gris para unidades
                }
            }
        }
        
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function updateClientsTable() {
            const tbody = document.getElementById('clientsTableBody');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #718096;">No hay clientes registrados</td></tr>';
                return;
            }
            
            tbody.innerHTML = clients.map(client => `
                <tr>
                    <td>${client.name}</td>
                    <td>${client.address || client.email}</td>
                    <td>${client.phone}</td>
                    <td>${new Date(client.dateAdded).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-warning" style="font-size: 12px; padding: 5px 10px;" onclick="editClient('${client.id}')">Editar</button>
                        <button class="btn btn-danger" style="font-size: 12px; padding: 5px 10px;" onclick="deleteClient('${client.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateCollectionsTable() {
            const tbody = document.getElementById('collectionsTableBody');
            
            if (collections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #718096;">No hay cobros registrados</td></tr>';
                return;
            }
            
            tbody.innerHTML = collections.map(collection => {
                const client = clients.find(c => c.id === collection.clientId);
                const statusIcon = {
                    'activo': 'üü¢',
                    'cumplido': '‚úÖ',
                    'vencido': 'üî¥'
                }[collection.status || 'activo'];
                
                return `
                    <tr>
                        <td>${client ? client.name : 'Cliente no encontrado'}</td>
                        <td>$${formatNumber(Math.round(collection.baseAmount || 0))}</td>
                        <td>$${formatNumber(Math.round((collection.baseAmount * collection.percentage / 100) || 0))} (${collection.percentage || 0}%)</td>
                        <td>$${formatNumber(Math.round(collection.dailyPayments || 0))}</td>
                        <td>${collection.installments || 1}</td>
                        <td>$${formatNumber(Math.round(collection.total || 0))}</td>
                        <td>$${formatNumber(Math.round(collection.remaining || 0))}</td>
                        <td>
                            <select onchange="updateCreditStatus('${collection.id}', this.value)" 
                                    style="background: ${collection.status === 'cumplido' ? '#e6ffed' : collection.status === 'vencido' ? '#ffe6e6' : '#e6f3ff'}; 
                                           border: none; padding: 4px 8px; border-radius: 4px;">
                                <option value="activo" ${collection.status === 'activo' ? 'selected' : ''}>üü¢ Activo</option>
                                <option value="cumplido" ${collection.status === 'cumplido' ? 'selected' : ''}>‚úÖ Cumplido</option>
                                <option value="vencido" ${collection.status === 'vencido' ? 'selected' : ''}>üî¥ Vencido</option>
                            </select>
                        </td>
                        <td>${new Date(collection.date).toLocaleDateString()}</td>
                        <td>${collection.description || 'Sin descripci√≥n'}</td>
                        <td>
                            <button class="btn btn-danger" style="font-size: 12px; padding: 5px 10px;" onclick="deleteCollection('${collection.id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateDashboardStats() {
            document.getElementById('totalClients').textContent = clients.length;
            const totalAmount = collections.reduce((sum, collection) => {
                return sum + (collection.baseAmount || 0);
            }, 0);
            const totalPaid = payments.reduce((sum, payment) => {
                return sum + payment.amount;
            }, 0);
            document.getElementById('totalCollections').textContent = formatCurrency(totalAmount);
            
            // Calcular ganancias del mes actual
            const monthlyProfits = calculateMonthlyProfits();
            document.getElementById('monthlyProfits').textContent = formatCurrency(monthlyProfits);
            
            // Colorear las ganancias seg√∫n el resultado
            const profitElement = document.getElementById('monthlyProfits');
            if (monthlyProfits > 0) {
                profitElement.style.color = '#48bb78'; // Verde para ganancias
            } else if (monthlyProfits < 0) {
                profitElement.style.color = '#e53e3e'; // Rojo para p√©rdidas
            } else {
                profitElement.style.color = '#718096'; // Gris para neutro
            }
        }
        
        function calculateMonthlyProfits() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Filtrar cobros del mes actual
            const monthlyCollections = collections.filter(collection => {
                const collectionDate = new Date(collection.date);
                return collectionDate.getMonth() === currentMonth && 
                       collectionDate.getFullYear() === currentYear;
            });
            
            // Calcular ganancias como el porcentaje espec√≠fico de cada cobro
            // La ganancia neta es el porcentaje espec√≠fico configurado para cada cr√©dito
            const totalProfits = monthlyCollections.reduce((sum, collection) => {
                const baseAmount = Math.round(collection.baseAmount || 0);
                const percentage = collection.percentage || 0;
                const profit = Math.round(baseAmount * (percentage / 100)); // Porcentaje espec√≠fico del pr√©stamo
                return sum + profit;
            }, 0);
            
            return Math.round(totalProfits);
        }

        function loadPageContent(pageName) {
            switch (pageName) {
                case 'clients':
                    updateClientsTable();
                    break;
                case 'collections':
                    updateCollectionsTable();
                    updatePaymentsTable();
                    break;
                case 'dashboard':
                    updateDashboardStats();
                    break;
                default:
                    break;
            }
        }

        // ===== REPORTES =====
        function generateMonthlyReport() {
            showNotification('Generando reporte mensual...', 'info');
            
            const totalAmount = collections.reduce((sum, c) => sum + (c.baseAmount || 0), 0);
            const totalPaid = payments.reduce((sum, p) => sum + p.amount, 0);
            const monthlyData = {
                totalClients: clients.length,
                totalCollections: collections.length,
                totalAmount: totalAmount,
                totalPaid: totalPaid,
                averageAmount: collections.length > 0 ? totalAmount / collections.length : 0
            };
            
            showNotification(`Reporte generado: ${monthlyData.totalClients} clientes, ${monthlyData.totalCollections} pr√©stamos por ${formatCurrency(totalAmount)}`, 'success');
        }

        function generateClientsReport() {
            showNotification('Generando reporte de clientes...', 'info');
            showNotification(`Reporte generado: ${clients.length} clientes registrados`, 'success');
        }

        function exportData() {
            const data = {
                clients: clients,
                collections: collections,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showNotification('Datos exportados exitosamente', 'success');
        }

        // ===== FUNCIONES DE EDICI√ìN =====
        function editClient(clientId) {
            console.log('üîç Funci√≥n editClient llamada con ID:', clientId);
            
            const client = clients.find(c => c.id === clientId);
            if (!client) {
                console.log('‚ùå Cliente no encontrado con ID:', clientId);
                showNotification('Cliente no encontrado', 'error');
                return;
            }
            
            console.log('‚úÖ Cliente encontrado:', client);
            
            // Navegar a la secci√≥n de clientes
            console.log('üìç Navegando a secci√≥n clientes...');
            navigateTo('clients');
            
            setTimeout(() => {
                console.log('üìã Llenando formulario con datos del cliente...');
                
                // Actualizar t√≠tulo del modal
                const title = document.getElementById('clientModalTitle');
                if (title) {
                    title.textContent = 'Editar Cliente';
                    console.log('‚úÖ T√≠tulo del modal actualizado');
                } else {
                    console.log('‚ùå Elemento #clientModalTitle no encontrado');
                }
                
                // Llenar campos del formulario
                const clientIdField = document.getElementById('clientId');
                const clientNameField = document.getElementById('clientName');
                const clientAddressRequiredField = document.getElementById('clientAddressRequired');
                const clientPhoneField = document.getElementById('clientPhone');
                const clientAddressField = document.getElementById('clientAddress');
                
                if (clientIdField) {
                    clientIdField.value = client.id;
                    console.log('‚úÖ clientId filled');
                } else {
                    console.log('‚ùå Elemento #clientId no encontrado');
                }
                
                if (clientNameField) {
                    clientNameField.value = client.name;
                    console.log('‚úÖ clientName filled');
                } else {
                    console.log('‚ùå Elemento #clientName no encontrado');
                }
                
                if (clientAddressRequiredField) {
                    clientAddressRequiredField.value = client.email || client.address; // Usar email como direcci√≥n obligatoria por compatibilidad
                    console.log('‚úÖ clientAddressRequired filled');
                } else {
                    console.log('‚ùå Elemento #clientAddressRequired no encontrado');
                }
                
                if (clientPhoneField) {
                    clientPhoneField.value = client.phone;
                    console.log('‚úÖ clientPhone filled');
                } else {
                    console.log('‚ùå Elemento #clientPhone no encontrado');
                }
                
                if (clientAddressField) {
                    clientAddressField.value = client.address || '';
                    console.log('‚úÖ clientAddress filled');
                } else {
                    console.log('‚ùå Elemento #clientAddress no encontrado');
                }
                
                // Cambiar texto del bot√≥n de env√≠o
                const submitButton = document.querySelector('#clientForm button[type="submit"]');
                if (submitButton) {
                    submitButton.textContent = 'Actualizar Cliente';
                    console.log('‚úÖ Bot√≥n submit actualizado');
                } else {
                    console.log('‚ùå Bot√≥n submit no encontrado');
                }
                
                // Mostrar modal
                const modal = document.getElementById('clientModal');
                if (modal) {
                    modal.style.display = 'flex';
                    console.log('‚úÖ Modal mostrado');
                } else {
                    console.log('‚ùå Modal #clientModal no encontrado');
                }
                
                // Focus en el primer campo
                setTimeout(() => {
                    if (clientNameField) {
                        clientNameField.focus();
                        console.log('üéØ Focus aplicado al primer campo');
                    }
                }, 200);
                
            }, 300);
        }

        function deleteClient(clientId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este cliente?')) {
                return;
            }
            
            clients = clients.filter(c => c.id !== clientId);
            localStorage.setItem('clients_demo_user', JSON.stringify(clients));
            
            // Eliminar cobros asociados
            collections = collections.filter(c => c.clientId !== clientId);
            localStorage.setItem('collections_demo_user', JSON.stringify(collections));
            
            updateClientsTable();
            updateCollectionsTable();
            updatePaymentsTable();
            updateDashboardStats();
            
            showNotification('Cliente eliminado exitosamente', 'success');
        }

        function deleteCollection(collectionId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este cobro?')) {
                return;
            }
            
            collections = collections.filter(c => c.id !== collectionId);
            localStorage.setItem('collections_demo_user', JSON.stringify(collections));
            
            updateCollectionsTable();
            updatePaymentsTable();
            updateDashboardStats();
            
            showNotification('Cobro eliminado exitosamente', 'success');
        }

        // ===== LOGOUT =====
        function logout() {
            if (!confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                return;
            }
            
            localStorage.removeItem('currentUser');
            showNotification('Sesi√≥n cerrada', 'info');
            
            setTimeout(() => {
                window.location.href = 'index_simple.html';
            }, 1000);
        }



        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si hay usuario logueado
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index_simple.html';
                return;
            }
            
            const user = JSON.parse(currentUser);
            document.getElementById('userName').textContent = user.name;
            
            // Cargar contenido inicial
            loadPageContent('dashboard');
            updatePaymentsTable(); // Inicializar tabla de pagos
            
            // Verificar cr√©ditos a los 30 d√≠as autom√°ticamente
            checkCreditsAfter30Days();
            
            // Event listeners para formularios
            document.getElementById('clientForm').addEventListener('submit', handleClientSubmit);
            document.getElementById('collectionForm').addEventListener('submit', handleCollectionSubmit);
            document.getElementById('paymentForm').addEventListener('submit', handlePaymentSubmit);
            
            // Verificar cr√©ditos cada 24 horas (86400000 ms)
            setInterval(() => {
                checkCreditsAfter30Days();
            }, 86400000); // 24 horas
        });


        // ===== SISTEMA DE BACKUP Y RECUPERACI√ìN =====

        function openBackupModal() {
            const modal = document.getElementById('backupModal');
            if (modal) {
                modal.style.display = 'flex';
                updateBackupInfo();
            }
        }

        function closeBackupModal() {
            const modal = document.getElementById('backupModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function updateBackupInfo() {
            // Actualizar contadores en el modal
            document.getElementById('backupClientsCount').textContent = clients.length;
            document.getElementById('backupCollectionsCount').textContent = collections.length;
            document.getElementById('backupPaymentsCount').textContent = payments.length;
        }

        function createBackup() {
            try {
                const backupData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    system: 'CR√âDITOS LA BENDICI√ìN',
                    data: {
                        clients: clients,
                        collections: collections,
                        payments: payments,
                        users: JSON.parse(localStorage.getItem('users') || '[]'),
                        currentUser: JSON.parse(localStorage.getItem('currentUser') || '{}')
                    }
                };

                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_creditos_la_bendicion_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // Guardar backup en historial local
                saveBackupToHistory(backupData);
                
                showNotification('Backup creado exitosamente', 'success');
            } catch (error) {
                console.error('Error creando backup:', error);
                showNotification('Error al crear backup', 'error');
            }
        }

        function exportClientsData() {
            try {
                const clientsData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    type: 'clients_only',
                    data: {
                        clients: clients
                    }
                };

                const dataStr = JSON.stringify(clientsData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `clientes_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showNotification('Datos de clientes exportados', 'success');
            } catch (error) {
                console.error('Error exportando clientes:', error);
                showNotification('Error al exportar clientes', 'error');
            }
        }

        function restoreFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.data) {
                        throw new Error('Formato de backup inv√°lido');
                    }

                    if (confirm('¬øEst√°s seguro de que quieres restaurar estos datos? Esto sobrescribir√° la informaci√≥n actual.')) {
                        // Restaurar datos
                        if (backupData.data.clients) {
                            clients = backupData.data.clients;
                            localStorage.setItem('clients_demo_user', JSON.stringify(clients));
                        }
                        
                        if (backupData.data.collections) {
                            collections = backupData.data.collections;
                            localStorage.setItem('collections_demo_user', JSON.stringify(collections));
                        }
                        
                        if (backupData.data.payments) {
                            payments = backupData.data.payments;
                            localStorage.setItem('payments_demo_user', JSON.stringify(payments));
                        }

                        // Actualizar tablas y estad√≠sticas
                        updateClientsTable();
                        updateCollectionsTable();
                        updatePaymentsTable();
                        updateDashboardStats();
                        updateBackupInfo();

                        showNotification('Datos restaurados exitosamente', 'success');
                        closeBackupModal();
                    }
                } catch (error) {
                    console.error('Error restaurando datos:', error);
                    showNotification('Error al restaurar datos: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Limpiar el input
            event.target.value = '';
        }

        function saveBackupToHistory(backupData) {
            const history = JSON.parse(localStorage.getItem('backupHistory') || '[]');
            history.unshift({
                id: Date.now(),
                timestamp: backupData.timestamp,
                size: JSON.stringify(backupData).length,
                clientsCount: backupData.data.clients.length,
                collectionsCount: backupData.data.collections.length,
                paymentsCount: backupData.data.payments.length
            });
            
            // Mantener solo los √∫ltimos 10 backups
            if (history.length > 10) {
                history.splice(10);
            }
            
            localStorage.setItem('backupHistory', JSON.stringify(history));
        }

        function showBackupHistory() {
            const history = JSON.parse(localStorage.getItem('backupHistory') || '[]');
            
            if (history.length === 0) {
                showNotification('No hay backups en el historial', 'info');
                return;
            }

            let historyText = 'üìã Historial de Backups:\n\n';
            history.forEach((backup, index) => {
                const date = new Date(backup.timestamp).toLocaleString();
                historyText += `${index + 1}. ${date}\n`;
                historyText += `   üìä Clientes: ${backup.clientsCount} | Pr√©stamos: ${backup.collectionsCount} | Pagos: ${backup.paymentsCount}\n`;
                historyText += `   üìÅ Tama√±o: ${(backup.size / 1024).toFixed(1)}KB\n\n`;
            });

            alert(historyText);
        }

        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                if (confirm('√∫ltima confirmaci√≥n: Se eliminar√°n todos los clientes, pr√©stamos y pagos.')) {
                    // Limpiar datos
                    localStorage.removeItem('clients_demo_user');
                    localStorage.removeItem('collections_demo_user');
                    localStorage.removeItem('payments_demo_user');
                    localStorage.removeItem('backupHistory');
                    
                    // Resetear variables
                    clients = [];
                    collections = [];
                    payments = [];
                    
                    // Actualizar interfaz
                    updateClientsTable();
                    updateCollectionsTable();
                    updatePaymentsTable();
                    updateDashboardStats();
                    updateBackupInfo();
                    
                    showNotification('Todos los datos han sido eliminados', 'success');
                    closeBackupModal();
                }
            }
        }

        // Cerrar modales con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeClientModal();
                closeCollectionModal();
                closePaymentModal();
                closeBackupModal();
                closePercentageConfigModal();
            }
        });
    </script>
</body>
</html>